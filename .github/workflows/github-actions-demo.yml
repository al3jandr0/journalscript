name: Journalscritp CICD pipeline
on:
  push:
    branches:
      - main
    pull_request:
      - main

defaults:
  run:
    shell: bash

jobs:
  unit_test:
    name: Unit test
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
        with:
          submodules: "true"
      - run: npm install -g bats
      - name: Install Bats
        run: bats -v
      - name: Run unit tests
        run: bats ./test
  build_man_page:
    name: Build man page
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies (pandoc)
        run: sudo apt-get install --yes pandoc
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Convert markup to man format
        run: |
          mkdir -p release
          pandoc --standalone --to=man --fail-if-warnings --output=release/journalscript.1 manpage.md
      - name: Upload man page
        uses: actions/upload-artifact@v3
        with:
          name: man-page
          path: release/journalscript.1
          retention-days: 5
  deb_package:
    name: Build debian package (artifact)
    needs: [build_man_page]
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Install dependencies
        run: sudo apt-get install --yes --no-install-recommends lintian dpkg gzip
      - name: Download manpage
        uses: actions/download-artifact@v3
        with:
          name: man-page
          path: ${{ github.workspace }}
      - name: Display structure of downloaded files
        run: ls -R release/
      - name: Build deb archive
        run: bash cicd/make_deb_archive.sh
      - name: Lint deb archive
        run: lintian --fail-on error --fail-on warning --no-tag-display-limit release/*.deb
      - name: Upload deb package artifact
        uses: actions/upload-artifact@v3
        with:
          name: deb-package
          path: release/*.deb
          if-no-files-found: error
          retention-days: 5
  version_check:
    runs-on: ubuntu-latest
    outputs:
      latest_tag: ${{ steps.check.outputs.latest_tag }}
      source_version: ${{ steps.check.outputs.source_version }}
      is_release: ${{ steps.check.outputs.is_release }}
    steps:
      - uses: actions/checkout@v3
      - name: Check Versions
        id: check
        run: |
          v=( $(bash cicd/get_versions.sh) )
          echo "latest_tag=${v[0]} source_version=${v[1]} is_release=${v[2]}"
          echo "latest_tag=${v[0]}" >> "$GITHUB_OUTPUT"
          echo "source_version=${v[1]}" >> "$GITHUB_OUTPUT"
          echo "is_release=${v[2]}" >> "$GITHUB_OUTPUT"
  release:
    runs-on: ubuntu-latest
    needs: [version_check, deb_package, unit_test]
    if: success() && github.ref_name == 'main' && needs.version_check.outputs.is_release == 'true'
    env:
      VERSION: ${{needs.version_check.outputs.source_version}}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Download all workflow run artifacts
        uses: actions/download-artifact@v3
        with:
          path: release/
      - name: Create Release Log
        run: bash cicd/extract_latest_release.sh CHANGELOG.md > release/RELEASE_LOG.md
      - name: Display structure of downloaded files
        run: |
          ls -R ${{ github.workspace }}
          cat release/RELEASE_LOG.md
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          name: Journalscript ${{ env.VERSION }}
          files: release/deb-package/journalscript*.deb
          body_path: release/RELEASE_LOG.md
          tag_name: ${{ env.VERSION }}
          prerelease: true
          fail_on_unmatched_files: true
  homebrew_formula:
    runs-on: ubuntu-latest
    needs: [version_check, release]
    if: success()
    env:
      VERSION: ${{needs.version_check.outputs.source_version}}
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Compute SHA256
        run: |
          gh release list
          gh release download ${{ env.VERSION }} --archive tar.gz --output release/archive.tar.gz
      - name: Create Homebrew formula
        run: |
          SHA256=$(sha256sum release/archive.ta.gz | cut -d ' ' -f 1)
          echo ${{ needs.release.outputs.assets }}
          #bash cicd/make_formula.sh ${{ fromJSON(needs.release.outputs.assets)[2].browser_download_url }} "$SHA256"
      - name: Upload Homebrew Formula to Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ needs.release.outputs.upload_url }}
          asset_path: release/journalscript.rb
          asset_name: journalscript.rb
